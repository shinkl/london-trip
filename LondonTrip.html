<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>倫敦行旅 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+TC:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'royal-navy': '#0F172A',
                        'british-red': '#8B0000',
                        'antique-gold': '#C5A065',
                        'parchment': '#F9F7F2',
                        'fog-grey': '#CFD8DC',
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', '"Playfair Display"', 'serif'],
                        cinzel: ['"Cinzel"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    },
                    boxShadow: {
                        'paper': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'floating': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    }
                }
            }
        }
    </script>

    <style>
        :root { --app-height: 100%; }
        body {
            background-color: #F9F7F2;
            background-image: radial-gradient(#C5A065 0.5px, transparent 0.5px);
            background-size: 20px 20px;
            color: #0F172A;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Lato', 'Noto Serif TC', sans-serif;
            overflow: hidden;
        }
        
        /* App 啟動畫面 */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #0F172A; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s ease-out;
        }

        /* 通用動畫 */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeInUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        /* 隱藏卷軸 */
        #main-container::-webkit-scrollbar, .hide-scroll::-webkit-scrollbar { display: none; }
        #main-container, .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* 毛玻璃 */
        .glass-nav {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(197, 160, 101, 0.3);
        }

        /* 分頁切換 */
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; }

        .btn-press:active { transform: scale(0.98); transition: transform 0.1s; }
        
        /* 詳情頁 Modal 樣式 */
        #detail-modal { transition: opacity 0.3s; }
        #detail-modal.hidden-modal { pointer-events: none; opacity: 0; }
        #detail-modal.visible-modal { pointer-events: auto; opacity: 1; }
        #modal-content { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform: translateY(100%); }
        .visible-modal #modal-content { transform: translateY(0); }
        
        /* 文字美化 */
        .rich-text p { margin-bottom: 1em; line-height: 1.6; }
        .rich-text strong { color: #0F172A; font-weight: 700; }
        .rich-text ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .rich-text li { margin-bottom: 0.5em; }
    </style>
</head>
<body class="flex flex-col h-[100dvh]">

    <div id="splash-screen">
        <div class="text-center">
            <i class="fa-solid fa-crown text-antique-gold text-5xl mb-4 animate-bounce"></i>
            <h1 class="font-cinzel text-3xl text-white tracking-[0.2em] border-b border-antique-gold pb-2">LONDON</h1>
            <p class="text-antique-gold font-serif italic mt-2 text-lg">2026 英倫之旅</p>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-[100] hidden-modal flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal()"></div>
        
        <div id="modal-content" class="relative w-full max-w-md bg-parchment rounded-t-3xl shadow-2xl h-[92vh] flex flex-col overflow-hidden">
            <div class="w-full h-6 bg-parchment flex justify-center items-center shrink-0 z-10 absolute top-0 left-0 rounded-t-3xl" onclick="closeModal()">
                <div class="w-12 h-1.5 bg-gray-300 rounded-full opacity-50"></div>
            </div>
            
            <div class="overflow-y-auto hide-scroll flex-1 pb-10" id="modal-body">
                <div id="modal-image" class="h-72 w-full bg-gray-300 relative bg-cover bg-center">
                    <div class="absolute inset-0 bg-gradient-to-t from-royal-navy via-royal-navy/30 to-transparent z-10"></div>
                    <div class="absolute bottom-6 left-6 z-20 right-6">
                        <span id="modal-tag" class="text-[10px] font-bold tracking-widest uppercase bg-antique-gold text-royal-navy px-2 py-1 rounded mb-3 inline-block shadow-sm">Category</span>
                        <h2 id="modal-title" class="text-3xl font-serif font-bold text-white leading-tight drop-shadow-lg">Title</h2>
                        <p id="modal-en" class="text-sm text-antique-gold italic mt-1 font-serif">English Name</p>
                    </div>
                    <button onclick="closeModal()" class="absolute top-6 right-6 bg-black/30 text-white w-9 h-9 rounded-full flex items-center justify-center backdrop-blur-md z-30 border border-white/20">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>

                <div class="px-6 py-6 space-y-8 bg-parchment">
                    <div class="rich-text text-base text-royal-navy font-serif leading-relaxed first-letter:text-3xl first-letter:font-bold first-letter:text-antique-gold first-letter:mr-1" id="modal-intro">
                        Intro text...
                    </div>
                    <div id="modal-sections" class="space-y-6">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-royal-navy text-white pt-safe-top pb-4 px-6 shadow-xl z-20 shrink-0 relative overflow-hidden">
        <div class="absolute top-0 right-0 opacity-10 transform translate-x-10 -translate-y-5">
            <i class="fa-solid fa-union-jack text-9xl"></i>
        </div>
        <div class="flex justify-between items-end mt-2 relative z-10">
            <div>
                <p class="text-antique-gold text-xs font-bold uppercase tracking-widest mb-1">Travel Itinerary</p>
                <h1 class="font-serif text-2xl font-bold tracking-wide">英國倫敦</h1>
            </div>
            <div class="text-right">
                <span class="block text-3xl font-cinzel text-white leading-none">Feb</span>
                <span class="block text-sm text-antique-gold">14 - 23</span>
            </div>
        </div>
    </header>

    <main id="main-container" class="flex-1 overflow-y-auto overflow-x-hidden bg-parchment pb-24 relative">
        
        <div id="plan" class="tab-content active px-4 py-6 space-y-6">
            <div class="bg-white rounded-xl shadow-floating p-5 relative overflow-hidden animate-in">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-british-red to-royal-navy"></div>
                <div class="flex justify-between items-center text-center mt-2">
                    <div><div class="text-3xl font-cinzel font-bold text-royal-navy">TPE</div><div class="text-xs text-gray-500">台北</div></div>
                    <div class="flex-1 px-4 flex flex-col items-center">
                        <i class="fa-solid fa-plane text-british-red text-lg mb-1"></i>
                        <div class="w-full h-px bg-gray-300"></div>
                        <span class="text-[10px] text-gray-400 mt-1">13h 15m</span>
                    </div>
                    <div><div class="text-3xl font-cinzel font-bold text-royal-navy">LHR</div><div class="text-xs text-gray-500">倫敦</div></div>
                </div>
            </div>

            <div class="bg-royal-navy text-parchment rounded-xl shadow-floating p-5 animate-in btn-press cursor-pointer relative z-10 overflow-hidden" style="animation-delay: 0.15s;" onclick="window.open('https://www.google.com/maps/search/?api=1&query=395+Oxford+St,+London+W1C+2JX', '_blank')">
                <div class="absolute -right-6 -bottom-6 text-8xl text-antique-gold opacity-10"><i class="fa-solid fa-hotel"></i></div>
                <div class="flex items-start relative z-10">
                    <div class="bg-antique-gold/20 p-3 rounded-full mr-4 shrink-0"><i class="fa-solid fa-map-pin text-antique-gold text-xl"></i></div>
                    <div>
                        <h3 class="font-serif text-lg font-bold text-antique-gold tracking-wide">倫敦住宿點</h3>
                        <p class="text-sm opacity-90 mt-2 leading-relaxed font-medium">395 Oxford St, London W1C 2JX, UK</p>
                        <div class="mt-4 inline-flex items-center text-xs text-royal-navy bg-antique-gold px-4 py-1.5 rounded-full font-bold shadow-sm hover:bg-white transition-colors">
                            <i class="fa-solid fa-location-arrow mr-2"></i> 開啟導航
                        </div>
                    </div>
                </div>
            </div>

            <div class="relative pl-4 animate-in" style="animation-delay: 0.2s;" id="itinerary-list"></div>
        </div>

        <div id="guide" class="tab-content px-4 py-6">
            <h2 class="font-serif text-2xl text-center text-royal-navy mb-8 relative font-bold">
                <span class="bg-parchment px-4 relative z-10">深度導覽</span>
                <div class="absolute top-1/2 left-0 w-full h-px bg-antique-gold/30 -z-0"></div>
            </h2>
            <p class="text-center text-xs text-gray-500 mb-6 -mt-4"><i class="fa-solid fa-hand-pointer mr-1 animate-pulse"></i> 點擊卡片查看完整介紹</p>

            <div class="grid grid-cols-1 gap-6" id="guide-list">
                </div>
        </div>

        <div id="wallet" class="tab-content px-4 py-6">
            <div class="bg-royal-navy rounded-2xl p-6 shadow-floating text-white relative overflow-hidden mb-6">
                <div class="absolute -right-10 -top-10 w-32 h-32 bg-antique-gold rounded-full opacity-10"></div>
                <h3 class="font-serif text-lg mb-6 flex items-center"><i class="fa-solid fa-sterling-sign mr-2 text-antique-gold"></i> 匯率換算</h3>
                <div class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">匯率設定</label>
                        <div class="flex items-center bg-white/10 rounded-lg px-3 border border-white/10">
                            <span class="text-antique-gold font-bold mr-2">£1 =</span>
                            <input type="number" id="exchange-rate" value="41.5" class="bg-transparent w-full py-3 text-white focus:outline-none font-mono text-lg" onchange="saveRate()">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">消費金額 (£)</label>
                        <input type="text" id="calc-input" placeholder="例如: 12.5 + 5" class="w-full bg-white/10 border border-white/10 rounded-lg py-3 px-3 text-white text-xl font-mono focus:outline-none focus:border-antique-gold transition placeholder-gray-600">
                    </div>
                    <button onclick="calculate()" class="w-full bg-antique-gold text-royal-navy font-bold py-3 rounded-lg shadow-lg btn-press mt-2">計算並換算</button>
                    <div class="pt-4 border-t border-white/10 flex justify-between items-end">
                        <span class="text-xs text-gray-400">約合台幣</span>
                        <span class="text-3xl font-serif font-bold text-white" id="result-twd">NT$ 0</span>
                    </div>
                </div>
            </div>
            <a href="https://liff.line.me/1655320992-Y8GowEpw/g/b1WMKQAKDaSBYNmzATGWNm" target="_blank" class="block bg-white rounded-xl p-4 shadow-paper btn-press border-l-4 border-green-600 flex justify-between items-center">
                <div class="flex items-center"><div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3"><i class="fa-brands fa-line text-green-600 text-xl"></i></div><div><h4 class="font-bold text-royal-navy">LINE 分帳群組</h4><p class="text-xs text-gray-500">點擊開啟記帳</p></div></div><i class="fa-solid fa-chevron-right text-gray-300"></i>
            </a>
        </div>

        <div id="lists" class="tab-content px-4 py-6">
            <div class="bg-white rounded-xl shadow-floating overflow-hidden mb-6">
                <div class="bg-royal-navy px-4 py-3 flex justify-between items-center">
                    <h3 class="font-serif text-white font-bold"><i class="fa-solid fa-suitcase mr-2 text-antique-gold"></i>必備物品</h3>
                    <span class="text-xs text-gray-400" id="progress-text">0/10</span>
                </div>
                <div class="p-2" id="checklist-container"></div>
            </div>
            <div class="bg-white rounded-xl shadow-floating overflow-hidden p-4 relative">
                <div class="absolute top-0 left-0 w-full h-1 bg-antique-gold"></div>
                <h3 class="font-serif text-royal-navy font-bold mb-3">筆記 & 連結備忘</h3>
                <textarea id="user-notes" class="w-full h-32 bg-parchment p-3 rounded-lg border border-gray-200 text-sm focus:outline-none focus:border-antique-gold resize-none" placeholder="輸入文字... 網址會自動轉為按鈕"></textarea>
                <div class="flex justify-end mt-2 gap-2"><button onclick="formatLinks()" class="text-xs bg-royal-navy text-white px-3 py-1.5 rounded btn-press"><i class="fa-solid fa-rotate mr-1"></i> 轉換模式</button></div>
                <div id="notes-preview" class="hidden mt-3 text-sm bg-parchment p-3 rounded-lg border border-dashed border-gray-300 break-words"></div>
            </div>
        </div>

        <div id="info" class="tab-content px-4 py-6">
            <div class="grid grid-cols-2 gap-4">
                <a href="https://www.bbc.com/weather/2643743" target="_blank" class="bg-gradient-to-br from-blue-500 to-blue-700 text-white rounded-xl p-4 shadow-floating btn-press flex flex-col items-center justify-center aspect-square"><i class="fa-solid fa-cloud-sun-rain text-4xl mb-2"></i><span class="font-serif font-bold">天氣預報</span></a>
                <div class="bg-gradient-to-br from-red-600 to-red-800 text-white rounded-xl p-4 shadow-floating btn-press flex flex-col items-center justify-center aspect-square"><i class="fa-solid fa-truck-medical text-4xl mb-2"></i><span class="font-serif font-bold">緊急求助</span><span class="text-xs mt-1">撥打 999</span></div>
            </div>
        </div>
    </main>

    <nav class="glass-nav fixed bottom-0 w-full pb-safe z-50 text-gray-400">
        <div class="flex justify-around items-center h-16">
            <button onclick="switchTab('plan')" class="nav-item active flex-1 flex flex-col items-center justify-center h-full btn-press group" id="nav-plan"><i class="fa-solid fa-compass text-xl mb-1 group-[.active]:text-antique-gold"></i><span class="text-[10px] tracking-widest font-bold group-[.active]:text-white">行程</span></button>
            <button onclick="switchTab('guide')" class="nav-item flex-1 flex flex-col items-center justify-center h-full btn-press group" id="nav-guide"><i class="fa-solid fa-book-open text-xl mb-1 group-[.active]:text-antique-gold"></i><span class="text-[10px] tracking-widest font-bold group-[.active]:text-white">導覽</span></button>
            <button onclick="switchTab('wallet')" class="nav-item flex-1 flex flex-col items-center justify-center h-full btn-press group" id="nav-wallet"><i class="fa-solid fa-wallet text-xl mb-1 group-[.active]:text-antique-gold"></i><span class="text-[10px] tracking-widest font-bold group-[.active]:text-white">錢包</span></button>
            <button onclick="switchTab('lists')" class="nav-item flex-1 flex flex-col items-center justify-center h-full btn-press group" id="nav-lists"><i class="fa-solid fa-list-check text-xl mb-1 group-[.active]:text-antique-gold"></i><span class="text-[10px] tracking-widest font-bold group-[.active]:text-white">清單</span></button>
            <button onclick="switchTab('info')" class="nav-item flex-1 flex flex-col items-center justify-center h-full btn-press group" id="nav-info"><i class="fa-solid fa-info text-xl mb-1 group-[.active]:text-antique-gold"></i><span class="text-[10px] tracking-widest font-bold group-[.active]:text-white">資訊</span></button>
        </div>
    </nav>

    <script>
        // --- 1. 深度圖文導覽資料庫 (V4.0) ---
        const guideData = [
            {
                id: 'tower_london',
                title: '倫敦塔',
                en: 'Tower of London',
                tag: '世界遺產',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c2/Tower_of_London_viewed_from_the_River_Thames.jpg/1280px-Tower_of_London_viewed_from_the_River_Thames.jpg',
                intro: '這座矗立在泰晤士河畔近千年的堡壘，見證了英國最黑暗與榮耀的歷史。它曾是皇宮、軍火庫、鑄幣廠，也是令人聞風喪膽的國家監獄與刑場。',
                details: [
                    { title: '核心建築：白塔 (White Tower)', content: '由征服者威廉於 1078 年下令建造，是諾曼軍事建築的典範。塔內現為皇家軍械庫博物館，展示亨利八世等國王的豪華盔甲。' },
                    { title: '必看：皇冠珠寶 (Crown Jewels)', content: '位於滑鐵盧兵營內，展示著仍在使用的帝國皇冠。最著名的包括鑲嵌在權杖上的「非洲之星I」（世界最大切割鑽石），以及鑲在皇冠上的「光之山」鑽石。' },
                    { title: '傳說與守護者', content: '<strong>守護者 (Yeoman Warders)</strong>：俗稱「食牛肉者 (Beefeaters)」，他們是退役資深軍人，也是這裡最棒的導遊。<br><strong>渡鴉傳說</strong>：查理二世深信，如果塔裡的六隻渡鴉飛走，白塔與王國就會崩塌。因此至今仍有專門的「渡鴉官」照料牠們。' },
                    { title: '血腥歷史', content: '這裡曾關押並處決過三位英格蘭王后（包括安妮·博林）。雖然現在已不再是監獄，但關於幽靈的傳說從未間斷。' }
                ]
            },
            {
                id: 'tower_bridge',
                title: '倫敦塔橋',
                en: 'Tower Bridge',
                tag: '城市地標',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/63/Tower_Bridge_from_Shad_Thames.jpg/1280px-Tower_Bridge_from_Shad_Thames.jpg',
                intro: '倫敦最具代表性的維多利亞時代工程奇蹟。它不是「倫敦橋」(London Bridge)，而是一座結合了懸索與蒸汽動力（現為電力）開啟裝置的複合橋樑。',
                details: [
                    { title: '建築設計', content: '為了與鄰近的倫敦塔協調，外觀採用了哥德式風格的石材覆蓋。兩座高塔之間有高空步道相連，下方則是可開合的橋面供車輛通行。' },
                    { title: '高空玻璃步道', content: '位於塔頂 42 公尺高的人行步道設有<strong>透明玻璃地板</strong>。站在上面可以直接俯瞰泰晤士河和腳下駛過的紅色雙層巴士，是測試膽量的好地方。' },
                    { title: '橋樑開啟', content: '至今橋面仍會為了讓高桅帆船通過而升起，平均每天約一到兩次。這是一個壯觀的景象，時間表可在官網查詢。' },
                    { title: '歷史趣聞', content: '1952 年，一輛 78 號雙層巴士在過橋時，橋面突然開始升起。司機 Albert Gunter 當機立斷加速衝刺，成功飛越了正在擴大的縫隙，全車乘客平安無事。' }
                ]
            },
            {
                id: 'borough_market',
                title: '波羅市場',
                en: 'Borough Market',
                tag: '美食聖地',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c0/Borough_Market%2C_London_-_Oct_2008.jpg/1280px-Borough_Market%2C_London_-_Oct_2008.jpg',
                intro: '倫敦最古老、最負盛名的食品市場，歷史可追溯至 12 世紀。位於鐵路高架橋下，充滿了工業風與歷史感，是全球老饕的必訪之地。',
                details: [
                    { title: '市場特色', content: '這裡匯集了英國與歐洲最頂級的生鮮食材、手工製品與街頭美食。不僅觀光客喜愛，許多倫敦頂級餐廳的主廚也會來此採購。' },
                    { title: '美食推薦', content: '<ul><li><strong>Richard Haward\'s Oysters</strong>：擁有兩百年歷史的生蠔攤位，新鮮便宜。</li><li><strong>Monmouth Coffee</strong>：總是大排長龍的倫敦傳奇咖啡店。</li><li><strong>Bread Ahead</strong>：他們的爆漿甜甜圈極受歡迎。</li><li>各式西班牙燉飯、松露野菇燉飯、起司三明治攤位。</li></ul>' },
                    { title: '電影場景', content: '市場周邊與內部常被作為電影取景地。最著名的是《哈利波特：阿茲卡班的逃犯》中，騎士公車停靠的「破釜酒吧」入口就在市場旁邊。' }
                ]
            },
            {
                id: 'westminster_abbey',
                title: '西敏寺',
                en: 'Westminster Abbey',
                tag: '皇室教堂',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Westminster_Abbey_by_Day.jpg/1280px-Westminster_Abbey_by_Day.jpg',
                intro: '英國皇室的御用教堂，宏偉的哥德式建築傑作。自 1066 年以來，幾乎所有英國君主的加冕典禮都在此舉行，也是舉辦皇室婚禮與葬禮的重要場所。',
                details: [
                    { title: '建築與歷史', content: '目前的建築大部分建於 13 至 16 世紀。擁有令人驚嘆的飛扶壁、玫瑰窗以及英國最高的哥德式中殿。' },
                    { title: '皇室大事紀', content: '威廉王子與凱特王妃的世紀婚禮（2011年），以及伊莉莎白二世女王的國葬（2022年）皆在此舉行。教堂內還有伊莉莎白一世與其對手蘇格蘭瑪麗女王的陵墓。' },
                    { title: '詩人角 (Poets\' Corner)', content: '位於南耳堂，埋葬或紀念了許多偉大的英國文學家與藝術家，包括喬叟、狄更斯、提尼生，也有莎士比亞的紀念碑。' },
                    { title: '加冕椅', content: '自 1308 年以來用於歷代君主加冕的古老木椅，平時放置在聖喬治禮拜堂內。' }
                ]
            },
            {
                id: 'london_dungeon',
                title: '倫敦地牢',
                en: 'The London Dungeon',
                tag: '驚悚體驗',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/London_Dungeon_entrance_County_Hall_London.jpg/1280px-London_Dungeon_entrance_County_Hall_London.jpg',
                intro: '一個結合了歷史、恐怖與黑色幽默的沈浸式劇場體驗。透過真人演員、特效與場景，帶你重回倫敦歷史上最黑暗、最血腥的時期。',
                details: [
                    { title: '體驗內容', content: '全程約 90 分鐘，觀眾會步行穿過不同的主題區域。演員會與觀眾互動（甚至挑選「受害者」受審），充滿了突如其來的驚嚇 (Jump scares)。' },
                    { title: '著名場景', content: '<ul><li><strong>開膛手傑克</strong>：在霧氣瀰漫的維多利亞街道上，追蹤這位未被抓獲的連環殺手。</li><li><strong>理髮師陶德</strong>：坐上他在艦隊街的理髮椅，體驗令人不安的刮鬍服務。</li><li><strong>蓋伊·福克斯</strong>：體驗火藥陰謀失敗後的審訊與刑求。</li></ul>' },
                    { title: '遊樂設施', content: '包含兩個小型室內遊樂設施：一個黑暗的乘船之旅（通往叛徒門），以及一個模擬絞刑的墜落塔（Drop Ride）。' },
                    { title: '警告', content: '內部非常昏暗，充滿大聲噪音、閃光與恐怖主題，不適合膽小者或幽閉恐懼症患者。' }
                ]
            },
            {
                id: 'british_museum',
                title: '大英博物館',
                en: 'British Museum',
                tag: '世界級博物館',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3a/British_Museum_from_NE_2.JPG/1280px-British_Museum_from_NE_2.JPG',
                intro: '成立於 1753 年，是世界上規模最大、最著名的博物館之一。收藏了來自全球各大洲、跨越人類 200 萬年歷史的珍貴文物，且維持著免費對外開放的傳統。',
                details: [
                    { title: '建築亮點：大中庭', content: '博物館中心原本是圖書館，後改建為「伊莉莎白二世大中庭」。由建築師 Norman Foster 設計的巨大玻璃網狀屋頂，是歐洲最大的有蓋廣場，光影效果極佳。' },
                    { title: '鎮館之寶：羅塞塔石碑', content: '一塊刻有古埃及象形文、埃及草書與古希臘文三種文字對照的石碑。它是 19 世紀學者解讀古埃及文字的關鍵鑰匙，也是館內人氣最高的展品。' },
                    { title: '必看展區', content: '<ul><li><strong>埃及館</strong>：擁有數量龐大的木乃伊、棺槨與巨大的拉美西斯二世頭像。</li><li><strong>希臘羅馬館</strong>：展出備受爭議但藝術價值極高的「帕德嫩神廟石雕 (Elgin Marbles)」。</li><li><strong>亞洲館</strong>：收藏精美的中國瓷器、書畫與來自敦煌的文物。</li></ul>' },
                    { title: '參觀建議', content: '館藏浩瀚，一天絕對看不完。建議租用語音導覽，並事先規劃好想看的重點展品路線。' }
                ]
            },
            {
                id: 'lion_king',
                title: '獅子王音樂劇',
                en: 'The Lion King Musical',
                tag: '西區音樂劇',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b6/Lyceum_Theatre%2C_London.jpg/1280px-Lyceum_Theatre%2C_London.jpg',
                intro: '改編自迪士尼經典動畫電影，自 1999 年在倫敦萊塞姆劇院 (Lyceum Theatre) 首演以來，已成為西區最長壽、最受歡迎的劇目之一。是一場視覺與聽覺的盛宴。',
                details: [
                    { title: '舞台藝術', content: '由導演茱莉·泰默 (Julie Taymor) 設計。最令人驚嘆的是結合了人體、面具與機械的動物木偶設計。演員透過踩高蹺操作長頸鹿、操控獵豹木偶奔跑，將非洲大草原的生態栩栩如生地呈現在舞台上。' },
                    { title: '故事大綱', content: '講述小獅子辛巴 (Simba) 的成長故事。他的父親木法沙被邪惡的叔叔刀疤陷害身亡，辛巴逃離家園，結識了丁滿與彭彭，過著無憂無慮的生活。最終在娜娜與拉飛奇的指引下，他承擔起責任，重返榮耀大地挑戰刀疤，奪回王位。故事靈感部分借鑑了莎士比亞的《哈姆雷特》。' },
                    { title: '經典曲目', content: '由艾爾頓·強 (Elton John) 與提姆·萊斯 (Tim Rice) 創作。包括開場震撼人心的《Circle of Life (生生不息)》、浪漫的《Can You Feel the Love Tonight》以及歡樂的《Hakuna Matata》。' },
                    { title: '觀劇提示', content: '開場時，大型動物會從觀眾席的走道走上舞台，如果你坐在走道旁，會有非常近距離的互動體驗。' }
                ]
            },
            {
                id: 'nhm',
                title: '自然史博物館',
                en: 'Natural History Museum',
                tag: '科學殿堂',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Natural_History_Museum%2C_London_-_entrance.jpg/1280px-Natural_History_Museum%2C_London_-_entrance.jpg',
                intro: '被譽為「自然的大教堂」，擁有超過 8000 萬件動植物、古生物與礦物標本。這座維多利亞時代的羅馬式建築本身就是一件令人驚嘆的藝術品。',
                details: [
                    { title: '建築特色', content: '由 Alfred Waterhouse 設計，外牆與內部使用了大量的陶土磚，並裝飾著精緻的動物與植物浮雕。根據展區不同，分別裝飾著現生動物（西翼）與已滅絕動物（東翼）的圖案。' },
                    { title: '大廳主角：Hope', content: '一進入欣采大廳 (Hintze Hall)，抬頭就會看到一具長達 25 公尺的藍鯨骨架懸掛在空中，它取代了之前的明星——梁龍骨架「Dippy」，象徵著對海洋環境保護的希望。' },
                    { title: '人氣展區', content: '<ul><li><strong>恐龍館</strong>：擁有著名的機械暴龍模型與大量化石。</li><li><strong>地球廳 (Red Zone)</strong>：入口是一個穿越地球核心的巨型紅色手扶梯，非常有科幻感。展示火山、地震與礦物。</li></ul>' },
                    { title: '達爾文中心', content: '一個現代化的科學研究設施，存放著數百萬件標本，遊客可以透過玻璃觀看科學家的工作。' }
                ]
            },
            {
                id: 'va_museum',
                title: 'V&A 博物館',
                en: 'Victoria and Albert Museum',
                tag: '藝術與設計',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/V%26A_Courtyard_Building.jpg/1280px-V%26A_Courtyard_Building.jpg',
                intro: '全球最大的裝飾藝術與設計博物館，以維多利亞女王及其夫婿艾伯特親王命名。收藏了跨越 5000 年人類歷史、來自世界各地的創意作品，從高級訂製服到古老雕塑應有盡有。',
                details: [
                    { title: '時尚與紡織品', content: 'V&A 的時尚館藏世界聞名，展示從 17 世紀的宮廷服裝到現代設計師如 Alexander McQueen、Vivienne Westwood 的作品，是時尚愛好者的聖地。' },
                    { title: '著名展廳', content: '<ul><li><strong>珠寶長廊</strong>：展示超過 3000 件璀璨的珠寶，包括拿破崙送給約瑟芬皇后的鑽石王冠。</li><li><strong>鑄模大廳 (Cast Courts)</strong>：展示歐洲著名雕塑與建築（如米開朗基羅的大衛像、圖拉真柱）的巨大石膏複製品。</li></ul>' },
                    { title: '世界最美咖啡廳', content: '博物館內的 Gamble Room、Morris Room 和 Poynter Room 是世界上最早的博物館餐廳，擁有華麗的維多利亞時期磁磚裝飾與彩繪玻璃，在此享用下午茶是獨特的體驗。' }
                ]
            },
            {
                id: 'harrods',
                title: '哈洛德百貨',
                en: 'Harrods',
                tag: '奢華百貨',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Harrods_at_night.jpg/1280px-Harrods_at_night.jpg',
                intro: '位於騎士橋 (Knightsbridge)，是世界上最著名、最奢華的百貨公司之一。它不僅是購物場所，更是一個充滿傳奇色彩的觀光景點，服務宗旨曾是「除此之外，什麼都賣」(Omnia Omnibus Ubique)。',
                details: [
                    { title: '建築與裝潢', content: '建築外觀在夜晚點亮 12,000 盞燈泡時極為壯觀。內部裝潢深受埃及風格影響，尤其是中央手扶梯區域，裝飾著法老雕像與象形文字，極盡奢華。' },
                    { title: '必逛：美食廳 (Food Halls)', content: '位於地下的美食廳是哈洛德的靈魂。裝潢如同宮殿般華麗，販售頂級的茶葉、巧克力、生鮮、熟食與異國香料。在這裡買一個經典的 Harrods 泰迪熊或購物袋是熱門選擇。' },
                    { title: '歷史趣聞', content: '哈洛德過去真的什麼都賣，其寵物部門曾經販售過獅子、老虎和鱷魚（現在已停止）。' },
                    { title: '紀念碑', content: '地下一樓設有黛安娜王妃與多迪·法耶茲的紀念碑（他們在 1997 年巴黎車禍中喪生，當時哈洛德的所有者是多迪的父親）。' }
                ]
            },
            {
                id: 'national_gallery',
                title: '國家美術館',
                en: 'The National Gallery',
                tag: '藝術殿堂',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/National_Gallery_London.jpg/1280px-National_Gallery_London.jpg',
                intro: '位於倫敦市中心的特拉法加廣場北側，收藏了 13 世紀中葉至 1900 年間、超過 2,300 幅西歐繪畫。是世界上最重要的美術館之一，且免費對外開放。',
                details: [
                    { title: '鎮館之寶', content: '<ul><li><strong>梵谷《向日葵》</strong>：印象派最著名的作品之一，鮮豔的黃色充滿生命力。</li><li><strong>達文西《岩間聖母》</strong>：文藝復興時期的傑作，展現了達文西精湛的光影處理技巧。</li><li><strong>范艾克《阿爾諾芬尼夫婦像》</strong>：北方文藝復興的代表作，以其驚人的細節與鏡中反射聞名。</li><li><strong>泰納《戰艦提梅梅爾號》</strong>：英國國寶級畫家泰納最受喜愛的作品。</li></ul>' },
                    { title: '參觀動線', content: '館藏依年代排列。如果時間有限，建議在大廳索取「必看 30 幅畫作」的導覽地圖，專注欣賞大師傑作。' },
                    { title: '建築位置', content: '美術館前方就是著名的特拉法加廣場與納爾遜紀念柱，是倫敦的地標中心。' }
                ]
            },
            {
                id: 'les_mis',
                title: '悲慘世界音樂劇',
                en: 'Les Misérables',
                tag: '經典史詩',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/Sondheim_Theatre_London_April_2022.jpg/1280px-Sondheim_Theatre_London_April_2022.jpg',
                intro: '改編自維克多·雨果的同名小說，是倫敦西區上演時間最長的音樂劇。這是一部關於愛、救贖、革命與人性光輝的史詩巨作，感動了全球無數觀眾。',
                details: [
                    { title: '演出特色', content: '這是一部「全唱式 (Sung-through)」音樂劇，幾乎沒有對白，所有劇情都透過歌曲推進。舞台設計巧妙，尤其是旋轉舞台的使用（雖然新版製作稍微簡化了），讓時空場景的切換非常流暢且富有電影感。' },
                    { title: '故事大綱', content: '背景設定在 19 世紀的法國。主角尚萬強 (Jean Valjean) 因偷了一塊麵包坐牢 19 年，假釋後試圖重新做人，卻不斷受到警探賈維 (Javert) 的追捕。故事跨越數十年，交織了芳汀的悲慘命運、珂賽特與馬利歐的愛情，以及 1832 年巴黎共和黨人起義的熱血與犧牲。' },
                    { title: '不朽名曲', content: '<ul><li><strong>I Dreamed a Dream</strong>：芳汀絕望的獨唱。</li><li><strong>Do You Hear the People Sing?</strong>：激昂的革命歌曲，象徵人民的力量。</li><li><strong>On My Own</strong>：愛波寧令人心碎的單戀之歌。</li><li><strong>One Day More</strong>：上半場結束前的大合唱，多條故事線交織的高潮。</li></ul>' }
                ]
            },
            {
                id: 'st_pauls',
                title: '聖保羅大教堂',
                en: 'St Paul\'s Cathedral',
                tag: '巴洛克傑作',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f5/St_Paul%27s_Cathedral_seen_from_the_south_bank_of_the_Thames.jpg/1280px-St_Paul%27s_Cathedral_seen_from_the_south_bank_of_the_Thames.jpg',
                intro: '倫敦最壯觀的巴洛克式建築，由建築大師克里斯多佛·雷恩爵士在 1666 年倫敦大火後重建設計。其巨大的圓頂主宰了倫敦天際線長達 300 多年。',
                details: [
                    { title: '國家象徵', content: '聖保羅大教堂見證了許多國家級重要時刻，包括邱吉爾的葬禮，以及查爾斯王子與黛安娜王妃的世紀婚禮。在二戰倫敦大轟炸期間，它奇蹟般地倖存下來，成為英國人不屈精神的象徵。' },
                    { title: '巨大圓頂', content: '高 111 公尺，是世界第二大的圓頂教堂（僅次於羅馬聖彼得大教堂）。' },
                    { title: '三重迴廊體驗', content: '<ul><li><strong>耳語廊 (Whispering Gallery)</strong>：位於圓頂內部，因特殊的聲學設計，在牆邊輕聲說話，對面的人也能清晰聽見。</li><li><strong>石迴廊 (Stone Gallery)</strong>：位於圓頂外部基座，可欣賞市區景色。</li><li><strong>金迴廊 (Golden Gallery)</strong>：位於圓頂最高處的塔尖下，需要爬 528 階樓梯，但能俯瞰絕美的倫敦全景。</li></ul>' },
                    { title: '地下室', content: '埋葬了許多國家英雄，包括納爾遜海軍上將、威靈頓公爵以及設計師雷恩爵士本人。' }
                ]
            },
            {
                id: 'buckingham',
                title: '白金漢宮',
                en: 'Buckingham Palace',
                tag: '皇室居所',
                imageUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8a/Buckingham_Palace_from_Gardens%2C_London%2C_UK_-_Diliff.jpg/1280px-Buckingham_Palace_from_Gardens%2C_London%2C_UK_-_Diliff.jpg',
                intro: '英國君主在倫敦的正式寢宮與辦公處，也是國家慶典與皇室娛樂的中心。宮殿前的廣場是英國人民在國家重要時刻聚集的地方。',
                details: [
                    { title: '皇室旗幟', content: '觀察宮殿上方飄揚的旗幟可以知道君主是否在家：如果掛的是紅黃藍三色的「皇家旗 (Royal Standard)」，代表國王在宮內；如果掛的是「英國國旗 (Union Jack)」，則代表國王不在。' },
                    { title: '衛兵交接儀式', content: '倫敦最受歡迎的免費觀光活動之一。穿著紅色制服、戴著高聳熊皮帽的皇家衛兵，在軍樂隊的伴奏下進行換崗。通常在上午 11:00 開始（夏季每天，冬季隔天，需事前查詢確切時間表）。' },
                    { title: '國事廳參觀', content: '每年夏季（通常是 7 月底至 10 月初），當君主前往蘇格蘭度假時，白金漢宮的 19 間豪華國事廳 (State Rooms) 會對外開放參觀，展示皇室珍藏的藝術品與家具。' },
                    { title: '維多利亞女王紀念碑', content: '位於宮殿正前方廣場中央的巨大金色雕像紀念碑，是為了紀念維多利亞女王而建。' }
                ]
            }
        ];

        // --- 2. 導覽列表渲染函式 (V4.0 - 圖文卡片版) ---
        function renderGuide() {
            const container = document.getElementById('guide-list');
            let html = '';
            
            guideData.forEach(item => {
                html += `
                    <div class="relative h-56 rounded-xl shadow-paper overflow-hidden btn-press cursor-pointer group" onclick="openModal('${item.id}')">
                        <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-105" style="background-image: url('${item.imageUrl}');"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-royal-navy/95 via-royal-navy/50 to-transparent"></div>
                        
                        <div class="absolute bottom-0 left-0 p-5 w-full text-white">
                            <div class="flex justify-between items-end">
                                <div>
                                    <span class="text-[10px] uppercase tracking-widest font-bold bg-antique-gold/90 text-royal-navy px-2 py-0.5 rounded inline-block mb-2 shadow-sm">${item.tag}</span>
                                    <h3 class="font-serif text-2xl font-bold leading-tight">${item.title}</h3>
                                    <p class="text-xs text-antique-gold italic opacity-90 mt-1 font-serif">${item.en}</p>
                                </div>
                                <div class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center border border-white/30">
                                    <i class="fa-solid fa-arrow-right text-white text-sm"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // --- 3. 詳情頁 Modal 控制 (V4.0 - 支援圖片) ---
        function openModal(id) {
            const item = guideData.find(d => d.id === id);
            if (!item) return;

            // 填充資料
            document.getElementById('modal-tag').innerText = item.tag;
            document.getElementById('modal-title').innerText = item.title;
            document.getElementById('modal-en').innerText = item.en;
            document.getElementById('modal-intro').innerHTML = item.intro;
            
            // 設定圖片
            document.getElementById('modal-image').style.backgroundImage = `url('${item.imageUrl}')`;

            // 生成詳細區段
            let detailsHtml = '';
            item.details.forEach((detail, index) => {
                detailsHtml += `
                    <div class="rich-text ${index !== item.details.length - 1 ? 'border-b border-gray-200 pb-6' : ''}">
                        <h4 class="font-bold text-lg text-royal-navy mb-3 flex items-center font-serif">
                            <span class="inline-block w-2 h-2 bg-antique-gold rounded-full mr-3"></span>${detail.title}
                        </h4>
                        <div class="text-sm text-gray-700 pl-5 font-sans leading-relaxed">
                            ${detail.content}
                        </div>
                    </div>
                `;
            });
            document.getElementById('modal-sections').innerHTML = detailsHtml;

            // 顯示 Modal
            const modal = document.getElementById('detail-modal');
            modal.classList.remove('hidden-modal');
            modal.classList.add('visible-modal');
            document.body.style.overflow = 'hidden'; // 禁止背景滾動
        }

        function closeModal() {
            const modal = document.getElementById('detail-modal');
            modal.classList.remove('visible-modal');
            modal.classList.add('hidden-modal');
            document.body.style.overflow = ''; // 恢復滾動
        }

        // --- 4. 其他原有資料與函式 ---
        const packingList = ["泳衣", "毛巾", "拖鞋", "信用卡", "牙刷", "護照", "英鎊", "保暖衣物", "轉接頭", "行動電源"];
        const itineraryData = [
            { date: "2/14", day: "週六", events: [{time:"06:00",title:"桃園機場 T1",type:"flight",note:"CI81 08:40"}, {time:"16:55",title:"希斯洛 T3",type:"flight",note:"抵達"}, {time:"19:00",title:"Check-in",type:"stay",note:"Oxford St"}, {time:"21:00",title:"Burger & Lobster",type:"food",note:"Bond St"}] },
            { date: "2/15", day: "週日", events: [{time:"08:15",title:"倫敦塔",type:"sight",note:"Tower of London"}, {time:"11:30",title:"波羅市場",type:"food",note:"Borough Market"}, {time:"15:00",title:"Skuna Boats",type:"fun",note:""}, {time:"18:30",title:"Blacklock",type:"food",note:"Canary Wharf"}] },
            { date: "2/16", day: "週一", events: [{time:"09:00",title:"西敏寺區",type:"sight",note:"Big Ben"}, {time:"12:30",title:"Pizza Pilgrims",type:"food",note:""}, {time:"14:00",title:"倫敦地牢",type:"fun",note:""}, {time:"晚餐",title:"Hoppers",type:"food",note:"Marylebone"}] },
            { date: "2/17", day: "週二", events: [{time:"09:10",title:"大英博物館",type:"sight",note:""}, {time:"13:00",title:"The Ninth",type:"food",note:""}, {time:"晚餐",title:"Barrafina",type:"food",note:"排隊"}, {time:"19:30",title:"獅子王",type:"show",note:"Lyceum Theatre"}] },
            { date: "2/18", day: "週三", events: [{time:"09:50",title:"自然史博物館",type:"sight",note:""}, {time:"PM",title:"V&A / Harrods",type:"walk",note:""}, {time:"17:00",title:"Dishoom",type:"food",note:"Kensington"}] },
            { date: "2/19", day: "週四", events: [{time:"09:30",title:"國家美術館",type:"sight",note:""}, {time:"12:00",title:"Bancone",type:"food",note:""}, {time:"15:00",title:"啤酒自行車",type:"fun",note:""}, {time:"19:30",title:"悲慘世界",type:"show",note:"Sondheim"}] },
            { date: "2/20", day: "週五", events: [{time:"08:00",title:"聖保羅大教堂",type:"sight",note:""}, {time:"13:00",title:"世界大戰體驗",type:"fun",note:""}, {time:"19:30",title:"Sky Garden",type:"sight",note:""}] },
            { date: "2/21", day: "週六", events: [{time:"AM",title:"唐人街",type:"walk",note:""}, {time:"13:00",title:"哈利波特影城",type:"fun",note:""}, {time:"19:30",title:"Arabica",type:"food",note:""}] },
            { date: "2/22", day: "週日", events: [{time:"14:30",title:"Murder Express",type:"fun",note:""}, {time:"PM",title:"紅磚巷市集",type:"walk",note:""}] },
            { date: "2/23", day: "週一", events: [{time:"10:30",title:"白金漢宮",type:"sight",note:""}, {time:"17:00",title:"LHR T3",type:"flight",note:"Home"}] }
        ];

        function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(el => { el.style.opacity = '0'; setTimeout(() => el.style.display = 'none', 300); });
            setTimeout(() => { const t = document.getElementById(tabId); t.style.display = 'block'; t.offsetHeight; t.style.opacity = '1'; document.getElementById('main-container').scrollTop = 0; }, 300);
        }

        function renderItinerary() {
            let html = '';
            itineraryData.forEach(day => {
                let evs = '';
                day.events.forEach(e => {
                    let c = 'text-gray-400', i = 'fa-circle', b = 'border-gray-300';
                    if(e.type==='flight'){c='text-british-red';i='fa-plane';b='border-british-red';}
                    if(e.type==='food'){c='text-antique-gold';i='fa-utensils';b='border-antique-gold';}
                    if(e.type==='show'){c='text-purple-700';i='fa-ticket';b='border-purple-700';}
                    if(e.type==='sight'){c='text-royal-navy';i='fa-camera';b='border-royal-navy';}
                    evs += `<div class="ml-6 mb-4 relative group btn-press"><div class="absolute -left-[33px] top-3 w-4 h-4 bg-parchment border-2 border-royal-navy rounded-full z-10 flex items-center justify-center"><div class="w-1.5 h-1.5 bg-royal-navy rounded-full"></div></div><div class="bg-white p-3 rounded shadow-paper border-l-4 ${b} flex justify-between items-start cursor-pointer" onclick="window.open('https://www.google.com/maps/search/?api=1&query=$${encodeURIComponent(e.title + " London")}', '_blank')"><div><div class="flex items-center gap-2 mb-1"><span class="font-bold text-royal-navy text-sm font-serif">${e.title}</span><i class="${i} ${c} text-xs opacity-70"></i></div><div class="text-xs text-gray-500 font-mono">${e.time} ${e.note?'• '+e.note:''}</div></div><i class="fa-solid fa-chevron-right text-gray-200 text-xs mt-2"></i></div></div>`;
                });
                html += `<div class="mb-6 relative"><div class="absolute left-1.5 top-8 bottom-0 w-0.5 bg-gray-300"></div><div class="flex items-baseline mb-2 relative z-10"><span class="text-3xl font-cinzel font-bold text-royal-navy mr-2">${day.date.split('/')[1]}</span><span class="text-xs font-bold text-antique-gold bg-royal-navy px-1.5 py-0.5 rounded">${day.day}</span></div>${evs}</div>`;
            });
            document.getElementById('itinerary-list').innerHTML = html;
        }

        function renderChecklist() {
            const s = JSON.parse(localStorage.getItem('uk_trip_checks')||'{}');
            const c = document.getElementById('checklist-container'); c.innerHTML=''; let n=0;
            packingList.forEach((t,i)=>{
                const ok=s[i]; if(ok)n++;
                const d=document.createElement('div'); d.className=`flex items-center p-3 border-b border-gray-100 last:border-0 ${ok?'bg-gray-50':''}`;
                d.innerHTML=`<div class="relative flex items-center cursor-pointer" onclick="toggleCheck(${i})"><div class="w-6 h-6 border-2 border-royal-navy rounded flex items-center justify-center ${ok?'bg-royal-navy':''}">${ok?'<i class="fa-solid fa-check text-white text-xs"></i>':''}</div><span class="ml-3 font-medium ${ok?'line-through text-gray-400':'text-royal-navy'}">${t}</span></div>`;
                c.appendChild(d);
            });
            document.getElementById('progress-text').innerText = `${n}/${packingList.length}`;
        }
        function toggleCheck(i){ const s=JSON.parse(localStorage.getItem('uk_trip_checks')||'{}'); s[i]=!s[i]; localStorage.setItem('uk_trip_checks',JSON.stringify(s)); renderChecklist(); }

        function saveRate(){ localStorage.setItem('uk_trip_rate',document.getElementById('exchange-rate').value); }
        function calculate(){ try{const r=parseFloat(document.getElementById('exchange-rate').value)||41.5; const v=eval(document.getElementById('calc-input').value); document.getElementById('result-twd').innerText="NT$ "+Math.round(v*r).toLocaleString();}catch(e){document.getElementById('result-twd').innerText="錯誤";}}
        
        function formatLinks() {
            const raw = document.getElementById('user-notes').value;
            const preview = document.getElementById('notes-preview');
            const textarea = document.getElementById('user-notes');
            if(textarea.classList.contains('hidden')) { preview.classList.add('hidden'); textarea.classList.remove('hidden'); }
            else { preview.innerHTML = raw.replace(/\n/g, '<br>').replace(/(https?:\/\/[^\s]+)/g, u=>`<a href="${u}" target="_blank" class="text-blue-600 underline"><i class="fa-solid fa-link text-xs"></i> 連結</a>`) || '<span class="text-gray-400 italic">無內容...</span>'; preview.classList.remove('hidden'); textarea.classList.add('hidden'); }
        }

        window.onload = function() {
            setTimeout(() => { const s=document.getElementById('splash-screen'); s.style.opacity='0'; setTimeout(()=>s.remove(),800); }, 1500);
            renderItinerary(); renderGuide(); renderChecklist();
            document.getElementById('user-notes').value = localStorage.getItem('uk_trip_notes')||'';
            document.getElementById('user-notes').addEventListener('input', function(){localStorage.setItem('uk_trip_notes',this.value)});
            const r = localStorage.getItem('uk_trip_rate'); if(r)document.getElementById('exchange-rate').value=r;
        };
    </script>
</body>
</html>